<header class="annotation-header" ng-if="!vm.user()">
  <strong>You must be logged in to create annotations and highlights.</strong>
</header>

<div ng-keydown="vm.onKeydown($event)" ng-if="vm.user()">

  <annotation-header annotation="vm.annotation"
                         is-editing="vm.editing()"
                         is-highlight="vm.isHighlight()"
                         is-private="vm.state().isPrivate"
                         on-reply-count-click="vm.onReplyCountClick()"
                         reply-count="vm.replyCount"
                         show-document-info="vm.showDocumentInfo">
  </annotation-header>

  <annotation-quote
    quote="vm.quote()"
    is-orphan="vm.isOrphan()"
    ng-if="vm.quote()">
  </annotation-quote>

  <annotation-body
    collapse="vm.collapseBody"
    is-editing="vm.editing()"
    is-hidden-by-moderator="vm.isHiddenByModerator()"
    on-collapsible-changed="vm.setBodyCollapsible(collapsible)"
    on-edit-text="vm.setText(text)"
    on-toggle-collapsed="vm.collapseBody = collapsed"
    text="vm.state().text">
  </annotation-body>

  <!-- Tags -->
  <div class="annotation-body form-field" ng-if="vm.editing()">
    <tag-editor tags="vm.state().tags"
                on-edit-tags="vm.setTags(tags)"></tag-editor>
  </div>

  <div class="annotation-body u-layout-row tags tags-read-only"
       ng-if="(vm.canCollapseBody || vm.state().tags.length) && !vm.editing()">
    <ul class="tag-list" aria-label="Annotation tags">
      <li class="tag-item" ng-repeat="tag in vm.state().tags">
        <a ng-href="{{vm.tagSearchURL(tag)}}" aria-label="Tag: {{tag}}" target="_blank">{{tag}}</a>
      </li>
    </ul>
    <div class="u-stretch"></div>
    <a class="annotation-link u-strong" ng-show="vm.canCollapseBody"
      ng-click="vm.toggleCollapseBody($event)"
      ng-title="vm.collapseBody ? 'Show the full annotation text' : 'Show the first few lines only'"
      ng-bind="vm.collapseBody ? 'More' : 'Less'"
      h-branding="accentColor"></a>
  </div>
  <!-- / Tags -->

  <footer class="annotation-footer">

    <div class="annotation-form-actions" ng-if="vm.editing()">
      <annotation-publish-control
        group="vm.group()"
        is-disabled="!vm.hasContent()"
        is-shared="vm.isShared()"
        on-cancel="vm.revert()"
        on-save="vm.save()"
        on-set-privacy="vm.setPrivacy(level)"></annotation-publish-control>
    </div>

    <div class="annotation-section annotation-license"
         ng-show="vm.shouldShowLicense()">
      <a class="annotation-license__link" href="http://creativecommons.org/publicdomain/zero/1.0/"
        title="View more information about the Creative Commons Public Domain dedication"
        target="_blank">
        <i class="h-icon-cc-logo"></i><i class="h-icon-cc-zero"></i>
        Annotations can be freely reused by anyone for any purpose.
      </a>
    </div>

    <div class="annotation-replies" ng-if="!vm.isReply() && vm.replyCount > 0">
      <a href=""
        ng-click="vm.onReplyCountClick()">
        <span class="annotation-replies__link">{{ vm.isCollapsed ? 'Show replies' : 'Hide replies' }}</span>
        <span class="annotation-replies__count">({{ vm.replyCount }})</span>
      </a>
    </div>

    <div class="annotation-actions" ng-if="vm.isSaving">
      Saving...
    </div>

    <div class="annotation-actions" ng-if="!vm.isSaving && !vm.editing() && vm.id()">
      <div ng-show="vm.isSaving">Savingâ€¦</div>
      <annotation-action-button
        icon="'edit'"
        is-disabled="vm.isDeleted()"
        label="'Edit'"
        ng-show="vm.authorize('update') && !vm.isSaving"
        on-click="vm.edit()"
      ></annotation-action-button>
      <annotation-action-button
        icon="'trash'"
        is-disabled="vm.isDeleted()"
        label="'Delete'"
        ng-show="vm.authorize('delete')"
        on-click="vm.delete()"
      ></annotation-action-button>
      <annotation-action-button
        icon="'reply'"
        is-disabled="vm.isDeleted()"
        label="'Reply'"
        on-click="vm.reply()"
      ></annotation-action-button>
      <span class="annotation-share-dialog-wrapper" ng-if="vm.incontextLink()">
        <annotation-share-control group="vm.group()" is-private="vm.state().isPrivate" share-uri="vm.incontextLink()"></annotation-share-control>
      </span>
      <span ng-if="vm.canFlag()">
        <annotation-action-button
         icon="'flag'"
         is-disabled="vm.isDeleted()"
         label="'Report this annotation to the moderators'"
         ng-if="!vm.isFlagged()"
         on-click="vm.flag()"
        ></annotation-action-button>
        <annotation-action-button
         class-name="'annotation-action-button--active'"
         icon="'flag--active'"
         is-disabled="vm.isDeleted()"
         label="'Annotation has been reported to the moderators'"
         ng-if="vm.isFlagged()"
        ></annotation-action-button>
      </span>
    </div>
  </footer>
</div>
